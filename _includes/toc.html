<!-- _includes/toc.html -->
{% assign minHeader = include.h_min | default: 2 %}
{% assign maxHeader = include.h_max | default: 4 %}

{% comment %} å®‰å…¨è¿‡æ»¤ï¼šç§»é™¤å¼‚å¸¸æ’ç‰ˆæ ‡ç­¾ {% endcomment %}
{% assign clean_html = include.html | replace: '<pFig>', '' | replace: '</pFig>', '' | replace: '<quad>', '' | replace: '</quad>', '' | replace: '<pos_', '' | replace: '>', '' %}

{% assign nodes = clean_html | split: '<h' %}
{% assign firstHeader = true %}
{% assign headerCount = 0 %}

{% capture toc %}
{% for node in nodes %}
  {% if node == "" %}
    {% continue %}
  {% endif %}
  
  {% comment %} å®‰å…¨æå–æ ‡é¢˜çº§åˆ« {% endcomment %}
  {% assign headerLevel = node | strip | slice: 0, 1 %}
  {% if headerLevel == "" or headerLevel contains "<" %}
    {% continue %}
  {% endif %}
  
  {% assign headerLevel = headerLevel | times: 1 %}
  {% if headerLevel < minHeader or headerLevel > maxHeader %}
    {% continue %}
  {% endif %}
  
  {% comment %} å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ˜¯æœ‰æ•ˆæ•°å­— {% endcomment %}
  {% if headerLevel == 0 or headerLevel > 6 %}
    {% continue %}
  {% endif %}
  
  {% assign _workspace = node | split: '</h' %}
  
  {% comment %} å®‰å…¨æå–ID - å¤šé‡ä¿æŠ¤ {% endcomment %}
  {% assign html_id = "" %}
  {% assign id_search = _workspace[0] | split: 'id="' %}
  {% if id_search.size > 1 %}
    {% assign id_part = id_search[1] | split: '"' %}
    {% assign html_id = id_part[0] | strip %}
  {% endif %}
  
  {% comment %} å¦‚æœIDä¸ºç©ºï¼Œä»æ ‡é¢˜ç”Ÿæˆå®‰å…¨ID {% endcomment %}
  {% if html_id == "" %}
    {% assign header_text = _workspace[0] | split: '>' %}
    {% if header_text.size > 1 %}
      {% assign header_text = header_text | last | strip_html | strip %}
      {% assign html_id = header_text | slugify %}
    {% endif %}
  {% endif %}
  
  {% comment %} æœ€ç»ˆå®‰å…¨å¤„ç†ID {% endcomment %}
  {% if html_id == "" %}
    {% assign html_id = "section-" | append: forloop.index %}
  {% endif %}
  
  {% assign html_id = html_id | replace: '<', '' | replace: '>', '' | replace: '"', '' | replace: "'", '' | replace: '&', '' %}
  
  {% comment %} æå–æ ‡é¢˜æ–‡æœ¬ - å¤šé‡è¿‡æ»¤ {% endcomment %}
  {% assign header_content = "" %}
  {% assign content_parts = _workspace[0] | split: '>' %}
  {% if content_parts.size > 1 %}
    {% assign header_content = content_parts | last %}
    
    {% comment %} è¿‡æ»¤å¼‚å¸¸æ ‡ç­¾å’Œå†…å®¹ {% endcomment %}
    {% assign header_content = header_content | replace: '<pFig>', '' | replace: '</pFig>', '' %}
    {% assign header_content = header_content | replace: '<quad>', '' | replace: '</quad>', '' %}
    {% assign header_content = header_content | replace: '<pos_', '' %}
    {% assign header_content = header_content | strip_html | strip %}
    
    {% comment %} è·³è¿‡ç©ºæ ‡é¢˜æˆ–å¼‚å¸¸å†…å®¹ {% endcomment %}
    {% if header_content == "" or header_content contains "pFig" or header_content contains "quad" or header_content contains "pos_" %}
      {% continue %}
    {% endif %}
  {% else %}
    {% continue %}
  {% endif %}
  
  {% comment %} å¼€å§‹ç›®å½•ç»“æ„ {% endcomment %}
  {% if firstHeader %}
    {% assign firstHeader = false %}
    <ul class="neko-toc-list">
  {% endif %}
  
  {% assign headerCount = headerCount | plus: 1 %}
  
  <li class="neko-toc-item neko-toc-level-{{ headerLevel }}">
    <a href="#{{ html_id }}" class="neko-toc-link">
      <span class="neko-toc-bullet">
        {% case headerLevel %}
          {% when 2 %}ğŸ¾
          {% when 3 %}ğŸ“Œ
          {% when 4 %}ğŸ”¹
          {% else %}â€¢ 
        {% endcase %}
      </span>
      {{ header_content }}
    </a>
    
    {% comment %} å¤„ç†å­å±‚çº§ {% endcomment %}
    {% unless forloop.last %}
      {% assign next_index = forloop.index0 | plus: 1 %}
      {% assign next_node = nodes[next_index] %}
      
      {% if next_node %}
        {% assign next_header_level = next_node | strip | slice: 0, 1 | times: 1 %}
        
        {% if next_header_level > headerLevel %}
          <ul class="neko-toc-sublist">
        {% elsif next_header_level < headerLevel %}
          </li>
          {% assign levels_to_close = headerLevel | minus: next_header_level %}
          {% for i in (1..levels_to_close) %}
            </ul></li>
          {% endfor %}
        {% else %}
          </li>
        {% endif %}
      {% else %}
        </li>
      {% endif %}
    {% endunless %}
{% endfor %}

{% comment %} å…³é—­æœªé—­åˆçš„æ ‡ç­¾ {% endcomment %}
{% if firstHeader == false %}
  {% for i in (1..headerCount) %}
    </li>
  {% endfor %}
  </ul>
{% endif %}
{% endcapture %}

{% comment %} æœ€ç»ˆå®‰å…¨æ£€æŸ¥ {% endcomment %}
{% assign toc = toc | strip %}
{% if toc == "" or toc contains "<pFig>" or toc contains "<quad>" or toc contains "pos_" %}
  {% comment %} å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œæ˜¾ç¤ºå¤‡é€‰ç›®å½• {% endcomment %}
  <div class="neko-toc-fallback">
    <p class="neko-toc-warning">ğŸ¾ ç›®å½•ç”Ÿæˆé‡åˆ°é—®é¢˜ï¼Œæ˜¾ç¤ºç®€åŒ–ç‰ˆæœ¬</p>
    <ul class="neko-toc-list">
      <li class="neko-toc-item">
        <a href="#å®ç”¨èµ„æºå¯¼èˆª" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ¾</span>å®ç”¨èµ„æºå¯¼èˆª
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#å®˜æ–¹èµ„æº" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ¯</span>å®˜æ–¹èµ„æº
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#ç©å®¶ç¤¾åŒº" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ‘¥</span>ç©å®¶ç¤¾åŒº
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#æˆ˜æœ¯å·¥å…·" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ› ï¸</span>æˆ˜æœ¯å·¥å…·
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#æ¸¸æˆæ•°æ®" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ“Š</span>æ¸¸æˆæ•°æ®
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#è½¦é˜Ÿæ ¸å¿ƒæˆå‘˜" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸš—</span>è½¦é˜Ÿæ ¸å¿ƒæˆå‘˜
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#æ¸¸æˆåç‰‡" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸ®</span>æ¸¸æˆåç‰‡
        </a>
      </li>
      <li class="neko-toc-item">
        <a href="#è½¦é˜Ÿè½½å…·å±•ç¤º" class="neko-toc-link">
          <span class="neko-toc-bullet">ğŸš€</span>è½¦é˜Ÿè½½å…·å±•ç¤º
        </a>
      </li>
    </ul>
  </div>
{% else %}
  {{ toc }}
{% endif %}

<style>
.neko-toc-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.neko-toc-item {
  margin-bottom: 8px;
}

.neko-toc-link {
  display: flex;
  align-items: center;
  padding: 10px 15px;
  color: #666;
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
}

.neko-toc-link:hover {
  background: rgba(255, 182, 193, 0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  transform: translateX(5px);
}

.neko-toc-link.active {
  background: rgba(255, 105, 180, 0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  font-weight: bold;
}

.neko-toc-bullet {
  margin-right: 10px;
  font-size: 16px;
}

.neko-toc-sublist {
  margin-left: 20px;
  margin-top: 5px;
}

.neko-toc-fallback {
  background: #fff9db;
  padding: 15px;
  border-radius: 10px;
  border-left: 4px solid #ff6b6b;
}

.neko-toc-warning {
  color: #ff6b6b;
  font-style: italic;
  margin-bottom: 10px;
}
</style>
