<!-- _includes/toc-sidebar.html -->
{% if page.toc != false and site.toc.enabled %}
<aside class="neko-toc-sidebar" id="nekoTocSidebar">
  <div class="neko-toc-header">
    <span class="neko-toc-icon">ğŸ¾</span>
    <h3 class="neko-toc-title">
      {% if site.toc.title %}
        {{ site.toc.title }}
      {% else %}
        æ–‡ç« ç›®å½•
      {% endif %}
    </h3>
    <!-- ä¸“é—¨ä¸ºViaæµè§ˆå™¨ä¼˜åŒ–çš„å…³é—­æŒ‰é’® -->
    <button class="neko-toc-close" id="nekoTocClose" 
            onclick="window.hideNekoToc ? window.hideNekoToc() : (document.getElementById('nekoTocSidebar').classList.remove('active'), document.getElementById('nekoTocOverlay').classList.remove('active'))"
            style="background:#ff69b4;color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;z-index:99999;position:relative;">
      âœ•
    </button>
  </div>
  
  <div class="neko-toc-content">
    {% include toc.html html=content sanitize=true class="neko-toc-list" h_min=site.toc.min_level h_max=site.toc.max_level %}
  </div>
</aside>

<!-- æ±‰å ¡èœå•æŒ‰é’® -->
<button class="neko-toc-toggle" id="nekoTocToggle" 
        onclick="window.toggleNekoToc ? window.toggleNekoToc() : (document.getElementById('nekoTocSidebar').classList.toggle('active'), document.getElementById('nekoTocOverlay').classList.toggle('active'))"
        style="position:fixed;top:20px;right:20px;width:50px;height:50px;background:#ff69b4;border-radius:50%;border:none;color:white;font-size:20px;z-index:9999;cursor:pointer;">
  ğŸ“‘
</button>

<!-- é®ç½©å±‚ -->
<div class="neko-toc-overlay" id="nekoTocOverlay" 
     onclick="window.hideNekoToc ? window.hideNekoToc() : (document.getElementById('nekoTocSidebar').classList.remove('active'), this.classList.remove('active'))"
     style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9998;display:none;"></div>

<style>
/* ä¸“é—¨é’ˆå¯¹Viaæµè§ˆå™¨çš„CSSä¿®å¤ */
/* é‡ç½®æ‰€æœ‰å¯èƒ½å½±å“æ ·å¼çš„å±æ€§ */
#nekoTocSidebar * {
  margin: 0 !important;
  padding: 0 !important;
  box-sizing: border-box !important;
  -webkit-box-sizing: border-box !important;
}

/* ä¾§è¾¹æ åŸºç¡€æ ·å¼ - é¿å…ä½¿ç”¨å¤æ‚å±æ€§ */
#nekoTocSidebar {
  position: fixed !important;
  top: 0 !important;
  right: -400px !important;
  width: 100% !important;
  max-width: 400px !important;
  height: 100vh !important;
  background: #fff0f5 !important; /* å›é€€çº¯è‰²ï¼Œé¿å…æ¸å˜ */
  background: linear-gradient(135deg, #fff0f5, #e6f7ff) !important;
  z-index: 10000 !important;
  transition: right 0.3s ease !important;
  display: flex !important;
  flex-direction: column !important;
  border-left: 3px solid #ffb6c1 !important;
  box-shadow: -5px 0 15px rgba(0,0,0,0.1) !important;
}

#nekoTocSidebar.active {
  right: 0 !important;
}

/* é’ˆå¯¹Viaæµè§ˆå™¨ç‰¹åˆ«å¤„ç†å¤´éƒ¨ */
#nekoTocSidebar .neko-toc-header {
  display: flex !important;
  align-items: center !important;
  padding: 20px !important;
  background: white !important;
  border-bottom: 2px dashed #ffb6c1 !important;
  min-height: 80px !important;
  position: relative !important;
  z-index: 10001 !important;
}

/* ä¸“é—¨ä¿®å¤Viaæµè§ˆå™¨çš„å…³é—­æŒ‰é’®é—®é¢˜ */
#nekoTocClose {
  /* é‡ç½®æ‰€æœ‰å¯èƒ½è¢«è¦†ç›–çš„æ ·å¼ */
  background: #ff69b4 !important;
  color: white !important;
  border: none !important;
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  font-size: 24px !important;
  cursor: pointer !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  position: relative !important;
  z-index: 10002 !important;
  opacity: 1 !important;
  visibility: visible !important;
  pointer-events: auto !important;
  transition: none !important; /* Viaæµè§ˆå™¨å¯èƒ½å¯¹transitionæ”¯æŒä¸å¥½ */
}

/* å¼ºåˆ¶hoverçŠ¶æ€ */
#nekoTocClose:hover,
#nekoTocClose:active {
  background: #ff1493 !important;
  transform: scale(1.1) !important;
}

/* å†…å®¹åŒºåŸŸ */
#nekoTocSidebar .neko-toc-content {
  flex: 1 !important;
  overflow-y: auto !important;
  padding: 20px !important;
  -webkit-overflow-scrolling: touch !important;
}

/* ç›®å½•é“¾æ¥æ ·å¼ */
.neko-toc-link {
  display: block !important;
  padding: 12px 15px !important;
  color: #666 !important;
  text-decoration: none !important;
  border-radius: 8px !important;
  margin-bottom: 5px !important;
  border-left: 3px solid transparent !important;
  transition: none !important; /* ç®€åŒ–è¿‡æ¸¡æ•ˆæœ */
}

.neko-toc-link:hover,
.neko-toc-link:active {
  background: #f0f0f0 !important;
  color: #ff69b4 !important;
  border-left-color: #ff69b4 !important;
}

.neko-toc-link.active {
  background: #ffe6f0 !important;
  color: #ff69b4 !important;
  border-left-color: #ff69b4 !important;
  font-weight: bold !important;
}

/* é®ç½©å±‚æ ·å¼ */
#nekoTocOverlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background: rgba(0,0,0,0.5) !important;
  z-index: 9999 !important;
  display: none !important;
}

#nekoTocOverlay.active {
  display: block !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  #nekoTocSidebar {
    max-width: 100% !important;
    right: -100% !important;
  }
  
  #nekoTocToggle {
    top: 15px !important;
    right: 15px !important;
    width: 45px !important;
    height: 45px !important;
  }
}

/* é’ˆå¯¹Viaæµè§ˆå™¨çš„ç‰¹æ®Šåª’ä½“æŸ¥è¯¢ */
@media screen and (max-width: 480px) {
  /* åœ¨Viaæµè§ˆå™¨ä¸­ç®€åŒ–åŠ¨ç”»æ•ˆæœ */
  #nekoTocSidebar {
    transition: right 0.2s ease !important;
  }
}
</style>

<script>
// ä¸“é—¨é’ˆå¯¹Viaæµè§ˆå™¨çš„JavaScriptä¿®å¤
(function() {
  'use strict';
  
  // æ£€æµ‹æ˜¯å¦ä¸ºViaæµè§ˆå™¨
  function isViaBrowser() {
    return navigator.userAgent.toLowerCase().indexOf('via') > -1 || 
           navigator.userAgent.toLowerCase().indexOf('viabrowser') > -1;
  }
  
  // ç®€åŒ–ç‰ˆçš„ç›®å½•æ§åˆ¶å‡½æ•° - ä¸“é—¨ä¸ºViaæµè§ˆå™¨ä¼˜åŒ–
  function initNekoTocForVia() {
    console.log('æ£€æµ‹åˆ°Viaæµè§ˆå™¨ï¼Œåº”ç”¨ç‰¹æ®Šä¼˜åŒ–');
    
    var sidebar = document.getElementById('nekoTocSidebar');
    var toggle = document.getElementById('nekoTocToggle');
    var closeBtn = document.getElementById('nekoTocClose');
    var overlay = document.getElementById('nekoTocOverlay');
    
    if (!sidebar || !toggle) return;
    
    // ç®€åŒ–æ˜¾ç¤ºå‡½æ•°
    function showSidebar() {
      sidebar.classList.add('active');
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    // ç®€åŒ–éšè—å‡½æ•°
    function hideSidebar() {
      sidebar.classList.remove('active');
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // åˆ‡æ¢å‡½æ•°
    function toggleSidebar() {
      if (sidebar.classList.contains('active')) {
        hideSidebar();
      } else {
        showSidebar();
      }
    }
    
    // ä½¿ç”¨æœ€åŸºç¡€çš„äº‹ä»¶ç»‘å®šæ–¹å¼
    if (toggle) {
      toggle.onclick = toggleSidebar;
    }
    
    if (closeBtn) {
      closeBtn.onclick = hideSidebar;
    }
    
    if (overlay) {
      overlay.onclick = hideSidebar;
    }
    
    // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
    var tocLinks = document.querySelectorAll('.neko-toc-link');
    for (var i = 0; i < tocLinks.length; i++) {
      tocLinks[i].onclick = function(e) {
        e.preventDefault();
        var targetId = this.getAttribute('href').substring(1);
        hideSidebar();
        // ç®€åŒ–æ»šåŠ¨
        var targetElement = document.getElementById(targetId);
        if (targetElement) {
          window.scrollTo({
            top: targetElement.offsetTop - 80,
            behavior: 'auto' // ä½¿ç”¨autoè€Œä¸æ˜¯smoothï¼Œæé«˜å…¼å®¹æ€§
          });
        }
      };
    }
    
    // é«˜äº®å½“å‰ç« èŠ‚ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function highlightActive() {
      var tocLinks = document.querySelectorAll('.neko-toc-link');
      var sections = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
      var currentSection = '';
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      for (var i = 0; i < sections.length; i++) {
        var section = sections[i];
        if (section.offsetTop - 100 <= scrollTop) {
          currentSection = section.id;
        }
      }
      
      for (var j = 0; j < tocLinks.length; j++) {
        tocLinks[j].classList.remove('active');
        if (tocLinks[j].getAttribute('href') === '#' + currentSection) {
          tocLinks[j].classList.add('active');
        }
      }
    }
    
    // ç›‘å¬æ»šåŠ¨
    window.onscroll = highlightActive;
    highlightActive(); // åˆå§‹é«˜äº®
    
    // ESCé”®å…³é—­
    document.onkeydown = function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        hideSidebar();
      }
    };
    
    // æš´éœ²å‡½æ•°åˆ°å…¨å±€
    window.toggleNekoToc = toggleSidebar;
    window.hideNekoToc = hideSidebar;
  }
  
  // æ ‡å‡†åˆå§‹åŒ–å‡½æ•°ï¼ˆç”¨äºå…¶ä»–æµè§ˆå™¨ï¼‰
  function initNekoTocStandard() {
    // è¿™é‡Œå¯ä»¥ä¿ç•™æ‚¨åŸæ¥çš„å®Œæ•´åŠŸèƒ½ä»£ç 
    // ä½†ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€åŒ–ç‰ˆ
    initNekoTocForVia();
  }
  
  // æ ¹æ®æµè§ˆå™¨ç±»å‹é€‰æ‹©åˆå§‹åŒ–æ–¹å¼
  if (isViaBrowser()) {
    // Viaæµè§ˆå™¨ä½¿ç”¨ç®€åŒ–ç‰ˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNekoTocForVia);
    } else {
      initNekoTocForVia();
    }
  } else {
    // å…¶ä»–æµè§ˆå™¨ä½¿ç”¨æ ‡å‡†ç‰ˆ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initNekoTocStandard);
    } else {
      initNekoTocStandard();
    }
  }
})();
</script>
{% endif %}
