<!-- _includes/toc-sidebar.html -->
{% if page.toc != false and site.toc.enabled %}
<!-- ç›®å½•ä¾§è¾¹æ å®¹å™¨ -->
<aside class="neko-toc-sidebar" id="nekoTocSidebar">
  <div class="neko-toc-header">
    <span class="neko-toc-icon">ğŸ¾</span>
    <h3 class="neko-toc-title">
      {% if site.toc.title %}
        {{ site.toc.title }}
      {% else %}
        æ–‡ç« ç›®å½•
      {% endif %}
    </h3>
    <!-- å…³é—­æŒ‰é’® - ä¿®å¤Viaæµè§ˆå™¨ç”µè„‘æ¨¡å¼é—®é¢˜ -->
    <button class="neko-toc-close" id="nekoTocClose" 
            onclick="window.hideNekoToc ? window.hideNekoToc() : (document.getElementById('nekoTocSidebar').classList.remove('active'), document.getElementById('nekoTocOverlay').classList.remove('active'))"
            style="background:#ff69b4;color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;z-index:10003;">
      âœ•
    </button>
  </div>
  
  <div class="neko-toc-content">
    {% include toc.html html=content sanitize=true class="neko-toc-list" h_min=site.toc.min_level h_max=site.toc.max_level %}
  </div>
</aside>

<!-- æ±‰å ¡èœå•æŒ‰é’® -->
<button class="neko-toc-toggle" id="nekoTocToggle" 
        onclick="window.toggleNekoToc ? window.toggleNekoToc() : (document.getElementById('nekoTocSidebar').classList.toggle('active'), document.getElementById('nekoTocOverlay').classList.toggle('active'))"
        style="position:fixed;top:20px;right:20px;width:50px;height:50px;background:#ff69b4;border-radius:50%;border:none;color:white;font-size:20px;z-index:10001;cursor:pointer;display:flex;align-items:center;justify-content:center;">
  ğŸ“‘
</button>

<!-- é®ç½©å±‚ -->
<div class="neko-toc-overlay" id="nekoTocOverlay" 
     onclick="window.hideNekoToc ? window.hideNekoToc() : (document.getElementById('nekoTocSidebar').classList.remove('active'), this.classList.remove('active'))"
     style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:none;"></div>

<style>
/* ==================== ç¬¬ä¸€æ­¥ï¼šCSSé‡ç½® ==================== */
/* ç¡®ä¿æ‰€æœ‰å…ƒç´ ä½¿ç”¨ç›¸åŒçš„ç›’æ¨¡å‹ */
.neko-toc-sidebar * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
}

/* ==================== ç¬¬äºŒæ­¥ï¼šä¾§è¾¹æ åŸºç¡€æ ·å¼ ==================== */
.neko-toc-sidebar {
  position: fixed;
  top: 0;
  right: -100%;
  width: 100%;
  max-width: 400px;
  height: 100vh;
  height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œæ›´å¥½çš„ç§»åŠ¨ç«¯æ”¯æŒ */
  background: linear-gradient(135deg, #fff0f5, #e6f7ff);
  background: -webkit-linear-gradient(135deg, #fff0f5, #e6f7ff);
  z-index: 10000;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
  border-left: 3px solid #ffb6c1;
  box-shadow: -5px 0 15px rgba(0,0,0,0.1);
  /* ä¿®å¤1ï¼šç¡®ä¿åˆå§‹çŠ¶æ€å®Œå…¨éšè— */
  visibility: hidden;
  opacity: 0;
}

/* æ¿€æ´»çŠ¶æ€ */
.neko-toc-sidebar.active {
  right: 0;
  /* ä¿®å¤2ï¼šæ¿€æ´»æ—¶æ‰æ˜¾ç¤º */
  visibility: visible;
  opacity: 1;
}

/* ==================== ç¬¬ä¸‰æ­¥ï¼šä¿®å¤ç”µè„‘æ¨¡å¼ä¸‹çš„æ˜¾ç¤ºé—®é¢˜ ==================== */
/* ç”µè„‘æ¨¡å¼ç‰¹æ®Šä¿®å¤ - ä¿®å¤bugï¼šé¿å…ä¸€ç›´æ‰“å¼€ */
@media (min-width: 769px) {
  .neko-toc-sidebar {
    right: -400px;
    /* ä¿®å¤3ï¼šç”µè„‘æ¨¡å¼ä¸‹ä¹Ÿè¦ç¡®ä¿åˆå§‹éšè— */
    visibility: hidden;
    opacity: 0;
  }
  
  .neko-toc-sidebar.active {
    right: 0;
    visibility: visible;
    opacity: 1;
  }
  
  /* å¼ºåˆ¶å…³é—­æŒ‰é’®åœ¨ç”µè„‘æ¨¡å¼ä¸‹å¯è§å¯ç‚¹å‡» */
  .neko-toc-close {
    background: #ff69b4 !important;
    color: white !important;
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 10003 !important;
  }
  
  /* ä¿®å¤4ï¼šç”µè„‘æ¨¡å¼ä¸‹é®ç½©å±‚ä¸éœ€è¦ */
  .neko-toc-overlay {
    display: none !important;
  }
  
  /* ä¿®å¤5ï¼šç”µè„‘æ¨¡å¼ä¸‹ä¾§è¾¹æ æ‰“å¼€æ—¶ï¼Œæ±‰å ¡èœå•éšè— */
  .neko-toc-sidebar.active ~ .neko-toc-toggle {
    display: none;
  }
}

/* ==================== ç¬¬å››æ­¥ï¼šå¤´éƒ¨æ ·å¼ ==================== */
.neko-toc-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: rgba(255,255,255,0.9);
  border-bottom: 2px dashed #ffb6c1;
  flex-shrink: 0;
  position: relative;
  z-index: 10002;
}

.neko-toc-icon {
  font-size: 24px;
  margin-right: 10px;
}

.neko-toc-title {
  font-size: 18px;
  color: #ff69b4;
  font-weight: bold;
  flex: 1;
  margin: 0;
}

/* ==================== ç¬¬äº”æ­¥ï¼šå…³é—­æŒ‰é’®å¼ºåŒ–æ ·å¼ ==================== */
.neko-toc-close {
  background: #ff69b4;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
  z-index: 10003;
}

.neko-toc-close:hover {
  background: #ff1493;
  transform: scale(1.1);
}

/* ==================== ç¬¬å…­æ­¥ï¼šå†…å®¹åŒºåŸŸ ==================== */
.neko-toc-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
}

/* ==================== ç¬¬ä¸ƒæ­¥ï¼šç›®å½•åˆ—è¡¨æ ·å¼ ==================== */
.neko-toc-list {
  list-style: none;
}

.neko-toc-item {
  margin-bottom: 8px;
}

.neko-toc-link {
  display: block;
  padding: 10px 15px;
  color: #666;
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
}

.neko-toc-link:hover,
.neko-toc-link:focus {
  background: rgba(255,182,193,0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  transform: translateX(5px);
}

.neko-toc-link.active {
  background: rgba(255,105,180,0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  font-weight: bold;
}

/* ==================== ç¬¬å…«æ­¥ï¼šæ±‰å ¡èœå•æŒ‰é’® ==================== */
.neko-toc-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #ff69b4, #ff1493);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 20px;
  cursor: pointer;
  z-index: 10001;
  box-shadow: 0 4px 12px rgba(255,105,180,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.neko-toc-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(255,105,180,0.4);
}

/* ==================== ç¬¬ä¹æ­¥ï¼šé®ç½©å±‚ ==================== */
.neko-toc-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  display: none;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

.neko-toc-overlay.active {
  display: block;
}

/* ==================== ç¬¬åæ­¥ï¼šå“åº”å¼è®¾è®¡ ==================== */
@media (max-width: 768px) {
  .neko-toc-sidebar {
    max-width: 100%;
    right: -100%;
  }
  
  .neko-toc-sidebar.active {
    right: 0;
  }
  
  .neko-toc-toggle {
    top: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
  }
}

/* å°å±å¹•ä¼˜åŒ– */
@media (max-width: 480px) {
  .neko-toc-header {
    padding: 15px;
  }
  
  .neko-toc-content {
    padding: 15px;
  }
  
  .neko-toc-close {
    width: 35px;
    height: 35px;
    font-size: 20px;
  }
}
</style>

<script>
// ==================== JavaScriptä¿®å¤ä»£ç  ====================
(function() {
    'use strict';
    
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (window.nekoTocInitialized) {
        return;
    }
    window.nekoTocInitialized = true;
    
    console.log('ğŸ¾ åˆå§‹åŒ–çŒ«å¨˜é£æ ¼ç›®å½•ä¾§è¾¹æ ...');
    
    // è·å–DOMå…ƒç´ 
    var sidebar = document.getElementById('nekoTocSidebar');
    var toggle = document.getElementById('nekoTocToggle');
    var closeBtn = document.getElementById('nekoTocClose');
    var overlay = document.getElementById('nekoTocOverlay');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!sidebar || !toggle) {
        console.warn('âŒ ç›®å½•ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    console.log('âœ… æ‰¾åˆ°æ‰€æœ‰å¿…éœ€çš„å…ƒç´ ');
    
    // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================
    
    // æ˜¾ç¤ºç›®å½•ä¾§è¾¹æ 
    function showNekoToc() {
        console.log('ğŸ“– æ‰“å¼€ç›®å½•ä¾§è¾¹æ ');
        if (!sidebar || !overlay) return;
        
        // ä¿®å¤bugï¼šç¡®ä¿ç§»é™¤å¯èƒ½å­˜åœ¨çš„é”™è¯¯çŠ¶æ€
        sidebar.classList.remove('force-hidden');
        
        sidebar.classList.add('active');
        
        // åªåœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºé®ç½©å±‚
        if (window.innerWidth <= 768) {
            overlay.classList.add('active');
        }
        
        // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        
        console.log('âœ… ä¾§è¾¹æ å·²æ‰“å¼€');
    }
    
    // éšè—ç›®å½•ä¾§è¾¹æ  - é‡ç‚¹ä¿®å¤ç”µè„‘ç«¯æ— æ³•å…³é—­çš„bug
    function hideNekoToc() {
        console.log('ğŸ“• å…³é—­ç›®å½•ä¾§è¾¹æ ');
        if (!sidebar || !overlay) return;
        
        // ä¿®å¤bugï¼šå¤šé‡æ–¹æ³•ç¡®ä¿ä¾§è¾¹æ å…³é—­
        // æ–¹æ³•1ï¼šç§»é™¤activeç±»
        sidebar.classList.remove('active');
        
        // æ–¹æ³•2ï¼šæ·»åŠ å¼ºåˆ¶éšè—ç±»ï¼ˆé’ˆå¯¹ç”µè„‘ç«¯bugï¼‰
        sidebar.classList.add('force-hidden');
        
        // æ–¹æ³•3ï¼šç›´æ¥è®¾ç½®æ ·å¼ï¼ˆç»ˆæå¤‡ç”¨æ–¹æ¡ˆï¼‰
        sidebar.style.right = window.innerWidth > 768 ? '-400px' : '-100%';
        sidebar.style.visibility = 'hidden';
        sidebar.style.opacity = '0';
        
        // éšè—é®ç½©å±‚
        overlay.classList.remove('active');
        overlay.style.display = 'none';
        
        // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        // ç¡®ä¿æ±‰å ¡èœå•å¯è§
        if (toggle) {
            toggle.style.display = 'flex';
        }
        
        console.log('âœ… ä¾§è¾¹æ å·²å…³é—­');
    }
    
    // åˆ‡æ¢ç›®å½•æ˜¾ç¤º/éšè—
    function toggleNekoToc() {
        var isActive = sidebar.classList.contains('active');
        console.log('ğŸ”„ åˆ‡æ¢ç›®å½•çŠ¶æ€:', isActive ? 'å…³é—­' : 'æ‰“å¼€');
        
        if (isActive) {
            hideNekoToc();
        } else {
            showNekoToc();
        }
    }
    
    // ==================== äº‹ä»¶ç»‘å®š ====================
    
    function bindEvents() {
        console.log('ğŸ”— ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
        
        // æ±‰å ¡èœå•æŒ‰é’®äº‹ä»¶
        if (toggle) {
            // æ¸…é™¤ä¹‹å‰çš„onclickï¼Œé˜²æ­¢é‡å¤ç»‘å®š
            toggle.onclick = null;
            
            // ä½¿ç”¨addEventListener
            toggle.addEventListener('click', function(e) {
                console.log('ğŸ–±ï¸ æ±‰å ¡æŒ‰é’®è¢«ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();
                toggleNekoToc();
                return false;
            }, { passive: false });
        }
        
        // å…³é—­æŒ‰é’®äº‹ä»¶ - å¤šé‡ç»‘å®šç¡®ä¿ç”µè„‘ç«¯å¯ç”¨
        if (closeBtn) {
            // æ¸…é™¤ä¹‹å‰çš„onclick
            closeBtn.onclick = null;
            
            // æ ‡å‡†äº‹ä»¶ç›‘å¬
            closeBtn.addEventListener('click', function(e) {
                console.log('âŒ å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
                e.preventDefault();
                e.stopPropagation();
                hideNekoToc();
                return false;
            }, { passive: false });
            
            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            closeBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                hideNekoToc();
                return false;
            }, { passive: false });
        }
        
        // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
        if (overlay) {
            overlay.onclick = null;
            overlay.addEventListener('click', function(e) {
                e.preventDefault();
                hideNekoToc();
                return false;
            }, { passive: false });
        }
        
        console.log('âœ… äº‹ä»¶ç»‘å®šå®Œæˆ');
    }
    
    // ==================== æ£€æµ‹å±å¹•å®½åº¦å¹¶åº”ç”¨åˆå§‹çŠ¶æ€ ====================
    
    function applyInitialState() {
        console.log('ğŸ“± æ£€æµ‹å±å¹•å®½åº¦:', window.innerWidth, 'px');
        
        // ç¡®ä¿åˆå§‹çŠ¶æ€æ˜¯éšè—çš„
        hideNekoToc();
        
        // å¦‚æœæ˜¯ç”µè„‘ç«¯ï¼Œåº”ç”¨ç‰¹æ®Šå¤„ç†
        if (window.innerWidth > 768) {
            console.log('ğŸ’» ç”µè„‘ç«¯æ¨¡å¼ï¼Œåº”ç”¨ç‰¹æ®Šå¤„ç†');
            
            // ç¡®ä¿ä¾§è¾¹æ åˆå§‹éšè—
            sidebar.style.right = '-400px';
            sidebar.style.visibility = 'hidden';
            sidebar.style.opacity = '0';
            
            // ç¡®ä¿é®ç½©å±‚éšè—
            overlay.style.display = 'none';
            
            // ç¡®ä¿æ±‰å ¡èœå•å¯è§
            toggle.style.display = 'flex';
        }
    }
    
    // ==================== åˆå§‹åŒ–å‡½æ•° ====================
    
    function initNekoToc() {
        console.log('ğŸš€ åˆå§‹åŒ–ç›®å½•ä¾§è¾¹æ åŠŸèƒ½');
        
        // åº”ç”¨åˆå§‹çŠ¶æ€
        applyInitialState();
        
        // ç»‘å®šäº‹ä»¶
        bindEvents();
        
        // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
        var tocLinks = document.querySelectorAll('.neko-toc-link');
        console.log('æ‰¾åˆ°ç›®å½•é“¾æ¥:', tocLinks.length);
        
        tocLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var targetId = this.getAttribute('href');
                if (targetId && targetId.startsWith('#')) {
                    hideNekoToc();
                    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
                    var targetElement = document.getElementById(targetId.substring(1));
                    if (targetElement) {
                        targetElement.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            }, { passive: false });
        });
        
        // ESCé”®å…³é—­
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' || e.keyCode === 27) {
                console.log('ESCé”®æŒ‰ä¸‹ï¼Œå…³é—­ç›®å½•');
                hideNekoToc();
                if (e.preventDefault) e.preventDefault();
            }
        }, { passive: false });
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°åº”ç”¨çŠ¶æ€
        window.addEventListener('resize', function() {
            console.log('ğŸ”„ çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°åº”ç”¨çŠ¶æ€');
            applyInitialState();
        }, { passive: true });
        
        console.log('ğŸ‰ ç›®å½•ä¾§è¾¹æ åˆå§‹åŒ–å®Œæˆ');
    }
    
    // ==================== æ£€æµ‹Viaæµè§ˆå™¨å¹¶åº”ç”¨ç‰¹æ®Šä¿®å¤ ====================
    
    function detectAndFixViaBrowser() {
        var userAgent = navigator.userAgent.toLowerCase();
        var isViaBrowser = userAgent.indexOf('via') > -1 || userAgent.indexOf('viabrowser') > -1;
        
        if (isViaBrowser) {
            console.log('ğŸ” æ£€æµ‹åˆ°Viaæµè§ˆå™¨ï¼Œåº”ç”¨ç‰¹æ®Šä¿®å¤');
            
            // Viaæµè§ˆå™¨ç‰¹æ®Šä¿®å¤
            if (closeBtn) {
                // å¼ºåˆ¶è®¾ç½®å…³é—­æŒ‰é’®æ ·å¼
                closeBtn.style.cssText = [
                    'background: #ff69b4 !important',
                    'color: white !important',
                    'opacity: 1 !important',
                    'visibility: visible !important',
                    'pointer-events: auto !important',
                    'cursor: pointer !important',
                    'z-index: 10003 !important',
                    'position: relative !important'
                ].join(';');
            }
            
            // æ·»åŠ Viaæµè§ˆå™¨ç‰¹å®šçš„äº‹ä»¶å¤„ç†
            document.addEventListener('click', function(e) {
                // ç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨æ—¶å…³é—­
                if (sidebar.classList.contains('active') && 
                    !sidebar.contains(e.target) && 
                    e.target !== toggle) {
                    hideNekoToc();
                }
            }, { passive: false });
        }
    }
    
    // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initNekoToc();
            detectAndFixViaBrowser();
        });
    } else {
        // DOMå·²ç»åŠ è½½å®Œæˆ
        setTimeout(function() {
            initNekoToc();
            detectAndFixViaBrowser();
        }, 100);
    }
    
    // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.toggleNekoToc = toggleNekoToc;
    window.hideNekoToc = hideNekoToc;
    window.showNekoToc = showNekoToc;
    
})();
</script>
{% endif %}
