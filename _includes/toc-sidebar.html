<!-- _includes/toc-sidebar.html -->
{% if page.toc != false and site.toc.enabled %}
<!-- ç›®å½•ä¾§è¾¹æ å®¹å™¨ -->
<aside class="neko-toc-sidebar" id="nekoTocSidebar">
  <div class="neko-toc-header">
    <span class="neko-toc-icon">ğŸ¾</span>
    <h3 class="neko-toc-title">
      {% if site.toc.title %}
        {{ site.toc.title }}
      {% else %}
        æ–‡ç« ç›®å½•
      {% endif %}
    </h3>
    <!-- å…³é—­æŒ‰é’® -->
    <button class="neko-toc-close" id="nekoTocClose">
      âœ•
    </button>
  </div>
  
  <div class="neko-toc-content">
    {% include toc.html html=content sanitize=true class="neko-toc-list" h_min=site.toc.min_level h_max=site.toc.max_level %}
  </div>
</aside>

<!-- æ±‰å ¡èœå•æŒ‰é’® -->
<button class="neko-toc-toggle" id="nekoTocToggle">
  ğŸ“‘
</button>

<!-- é®ç½©å±‚ -->
<div class="neko-toc-overlay" id="nekoTocOverlay"></div>

<style>
/* ==================== é‡ç½®å’ŒåŸºç¡€æ ·å¼ ==================== */
.neko-toc-sidebar * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
}

/* ==================== ä¾§è¾¹æ åŸºç¡€æ ·å¼ - ç¡®ä¿å§‹ç»ˆéšè— ==================== */
.neko-toc-sidebar {
  position: fixed;
  top: 0;
  /* ä¿®å¤å…³é”®ï¼šå§‹ç»ˆåœ¨å±å¹•å¤–ï¼Œä¸å—åª’ä½“æŸ¥è¯¢å½±å“ */
  right: -100%;
  width: 100%;
  max-width: 400px;
  height: 100vh;
  height: 100dvh;
  background: linear-gradient(135deg, #fff0f5, #e6f7ff);
  background: -webkit-linear-gradient(135deg, #fff0f5, #e6f7ff);
  z-index: 10000;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
  border-left: 3px solid #ffb6c1;
  box-shadow: -5px 0 15px rgba(0,0,0,0.1);
  /* ä¿®å¤å…³é”®ï¼šç¡®ä¿ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å¯è§ */
  visibility: hidden;
  opacity: 0;
  pointer-events: none;
}

/* æ¿€æ´»çŠ¶æ€ - æ˜ç¡®ä¸”å¼ºåˆ¶ */
.neko-toc-sidebar.active {
  /* æ¿€æ´»æ—¶æ‰æ˜¾ç¤ºåœ¨å±å¹•å†… */
  right: 0;
  visibility: visible;
  opacity: 1;
  pointer-events: auto;
}

/* ==================== ç§»é™¤æœ‰é—®é¢˜çš„åª’ä½“æŸ¥è¯¢ ==================== */
/* æ³¨é‡Šæ‰æˆ–åˆ é™¤å¯èƒ½å¯¼è‡´è‡ªåŠ¨æ˜¾ç¤ºçš„åª’ä½“æŸ¥è¯¢ */
/* åŸä»£ç ä¸­å¯èƒ½å¯¼è‡´é—®é¢˜çš„éƒ¨åˆ†ï¼š
@media (min-width: 769px) {
  .neko-toc-sidebar {
    right: -400px;  â† è¿™ä¸ªå¯èƒ½è¢«æŸäº›æµè§ˆå™¨é”™è¯¯è§£æ
  }
}
*/

/* ä¿®å¤ï¼šåªæœ‰ä¸€ä¸ªç»Ÿä¸€çš„åª’ä½“æŸ¥è¯¢ï¼Œç”¨äºè°ƒæ•´å®½åº¦ */
@media (min-width: 769px) {
  .neko-toc-sidebar {
    max-width: 400px;
  }
  
  .neko-toc-sidebar.active {
    right: 0;
  }
}

/* ==================== å¤´éƒ¨æ ·å¼ ==================== */
.neko-toc-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: rgba(255,255,255,0.9);
  border-bottom: 2px dashed #ffb6c1;
  flex-shrink: 0;
  position: relative;
  z-index: 10002;
}

.neko-toc-icon {
  font-size: 24px;
  margin-right: 10px;
}

.neko-toc-title {
  font-size: 18px;
  color: #ff69b4;
  font-weight: bold;
  flex: 1;
  margin: 0;
}

/* ==================== å…³é—­æŒ‰é’® ==================== */
.neko-toc-close {
  background: #ff69b4;
  color: white;
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
  z-index: 10003;
}

.neko-toc-close:hover {
  background: #ff1493;
  transform: scale(1.1);
}

/* ==================== å†…å®¹åŒºåŸŸ ==================== */
.neko-toc-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  -webkit-overflow-scrolling: touch;
}

/* ==================== ç›®å½•åˆ—è¡¨æ ·å¼ ==================== */
.neko-toc-list {
  list-style: none;
}

.neko-toc-item {
  margin-bottom: 8px;
}

.neko-toc-link {
  display: block;
  padding: 10px 15px;
  color: #666;
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
}

.neko-toc-link:hover,
.neko-toc-link:focus {
  background: rgba(255,182,193,0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  transform: translateX(5px);
}

.neko-toc-link.active {
  background: rgba(255,105,180,0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  font-weight: bold;
}

/* ==================== æ±‰å ¡èœå•æŒ‰é’® ==================== */
.neko-toc-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #ff69b4, #ff1493);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 20px;
  cursor: pointer;
  z-index: 10001;
  box-shadow: 0 4px 12px rgba(255,105,180,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.neko-toc-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(255,105,180,0.4);
}

/* ==================== é®ç½©å±‚ ==================== */
.neko-toc-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 9999;
  display: none;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

.neko-toc-overlay.active {
  display: block;
}

/* ==================== å“åº”å¼è®¾è®¡ ==================== */
@media (max-width: 768px) {
  .neko-toc-sidebar {
    max-width: 100%;
  }
  
  .neko-toc-toggle {
    top: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
  }
}

@media (max-width: 480px) {
  .neko-toc-header {
    padding: 15px;
  }
  
  .neko-toc-content {
    padding: 15px;
  }
  
  .neko-toc-close {
    width: 35px;
    height: 35px;
    font-size: 20px;
  }
}
</style>

<script>
// ==================== ä¿®å¤åçš„JavaScript ====================
(function() {
    'use strict';
    
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (window.nekoTocInitialized) {
        return;
    }
    window.nekoTocInitialized = true;
    
    console.log('ğŸ¾ åˆå§‹åŒ–çŒ«å¨˜é£æ ¼ç›®å½•ä¾§è¾¹æ ...');
    
    // è·å–DOMå…ƒç´ 
    var sidebar = document.getElementById('nekoTocSidebar');
    var toggle = document.getElementById('nekoTocToggle');
    var closeBtn = document.getElementById('nekoTocClose');
    var overlay = document.getElementById('nekoTocOverlay');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!sidebar || !toggle) {
        console.warn('âŒ ç›®å½•ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    console.log('âœ… æ‰¾åˆ°æ‰€æœ‰å¿…éœ€çš„å…ƒç´ ');
    
    // ==================== ä¿®å¤å…³é”®ï¼šå¼ºåˆ¶åˆå§‹çŠ¶æ€ ====================
    function forceInitialHiddenState() {
        console.log('ğŸ”§ å¼ºåˆ¶è®¾ç½®åˆå§‹éšè—çŠ¶æ€');
        
        // 1. ç¡®ä¿ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„activeç±»
        sidebar.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        
        // 2. å¼ºåˆ¶è®¾ç½®å†…è”æ ·å¼ï¼Œè¦†ç›–ä»»ä½•CSS
        sidebar.style.right = '-100%';
        sidebar.style.visibility = 'hidden';
        sidebar.style.opacity = '0';
        sidebar.style.pointerEvents = 'none';
        
        // 3. ç¡®ä¿é®ç½©å±‚éšè—
        if (overlay) {
            overlay.style.display = 'none';
        }
        
        // 4. ç¡®ä¿é¡µé¢å¯ä»¥æ»šåŠ¨
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        console.log('âœ… åˆå§‹éšè—çŠ¶æ€å·²å¼ºåˆ¶è®¾ç½®');
    }
    
    // ==================== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ====================
    
    // æ˜¾ç¤ºç›®å½•ä¾§è¾¹æ 
    function showNekoToc() {
        console.log('ğŸ“– æ‰“å¼€ç›®å½•ä¾§è¾¹æ ');
        if (!sidebar) return;
        
        // æ·»åŠ activeç±»
        sidebar.classList.add('active');
        
        // æ›´æ–°æ ·å¼
        sidebar.style.right = '0';
        sidebar.style.visibility = 'visible';
        sidebar.style.opacity = '1';
        sidebar.style.pointerEvents = 'auto';
        
        // åªåœ¨ç§»åŠ¨ç«¯æ˜¾ç¤ºé®ç½©å±‚
        if (overlay && window.innerWidth <= 768) {
            overlay.classList.add('active');
            overlay.style.display = 'block';
        }
        
        // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
        
        console.log('âœ… ä¾§è¾¹æ å·²æ‰“å¼€');
    }
    
    // éšè—ç›®å½•ä¾§è¾¹æ 
    function hideNekoToc() {
        console.log('ğŸ“• å…³é—­ç›®å½•ä¾§è¾¹æ ');
        
        // ç§»é™¤activeç±»
        sidebar.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        
        // å¼ºåˆ¶é‡ç½®æ ·å¼
        sidebar.style.right = '-100%';
        sidebar.style.visibility = 'hidden';
        sidebar.style.opacity = '0';
        sidebar.style.pointerEvents = 'none';
        
        // éšè—é®ç½©å±‚
        if (overlay) {
            overlay.style.display = 'none';
        }
        
        // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        console.log('âœ… ä¾§è¾¹æ å·²å…³é—­');
    }
    
    // åˆ‡æ¢ç›®å½•æ˜¾ç¤º/éšè—
    function toggleNekoToc() {
        var isActive = sidebar.classList.contains('active');
        console.log('ğŸ”„ åˆ‡æ¢ç›®å½•çŠ¶æ€:', isActive ? 'å…³é—­' : 'æ‰“å¼€');
        
        if (isActive) {
            hideNekoToc();
        } else {
            showNekoToc();
        }
    }
    
    // ==================== äº‹ä»¶ç»‘å®š ====================
    
    function bindEvents() {
        console.log('ğŸ”— ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
        
        // æ±‰å ¡èœå•æŒ‰é’®äº‹ä»¶
        if (toggle) {
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleNekoToc();
            });
        }
        
        // å…³é—­æŒ‰é’®äº‹ä»¶
        if (closeBtn) {
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                hideNekoToc();
            });
        }
        
        // é®ç½©å±‚ç‚¹å‡»äº‹ä»¶
        if (overlay) {
            overlay.addEventListener('click', function(e) {
                e.preventDefault();
                hideNekoToc();
            });
        }
        
        // ç›®å½•é“¾æ¥ç‚¹å‡»äº‹ä»¶
        var tocLinks = document.querySelectorAll('.neko-toc-link');
        console.log('æ‰¾åˆ°ç›®å½•é“¾æ¥:', tocLinks.length);
        
        tocLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                var targetId = this.getAttribute('href');
                if (targetId && targetId.startsWith('#')) {
                    hideNekoToc();
                    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
                    var targetElement = document.getElementById(targetId.substring(1));
                    if (targetElement) {
                        targetElement.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                }
            });
        });
        
        // ESCé”®å…³é—­
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                console.log('ESCé”®æŒ‰ä¸‹ï¼Œå…³é—­ç›®å½•');
                hideNekoToc();
            }
        });
        
        console.log('âœ… äº‹ä»¶ç»‘å®šå®Œæˆ');
    }
    
    // ==================== åˆå§‹åŒ–å‡½æ•° ====================
    
    function initNekoToc() {
        console.log('ğŸš€ åˆå§‹åŒ–ç›®å½•ä¾§è¾¹æ åŠŸèƒ½');
        
        // ä¿®å¤å…³é”®ï¼šåœ¨åˆå§‹åŒ–æ—¶å¼ºåˆ¶è®¾ç½®éšè—çŠ¶æ€
        forceInitialHiddenState();
        
        // ç»‘å®šäº‹ä»¶
        bindEvents();
        
        console.log('ğŸ‰ ç›®å½•ä¾§è¾¹æ åˆå§‹åŒ–å®Œæˆ');
    }
    
    // ==================== é¡µé¢åŠ è½½åˆå§‹åŒ– ====================
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            // ä¿®å¤å…³é”®ï¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿æ‰€æœ‰æ ·å¼å·²åŠ è½½
            setTimeout(initNekoToc, 100);
        });
    } else {
        // DOMå·²ç»åŠ è½½å®Œæˆ
        setTimeout(initNekoToc, 100);
    }
    
    // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.toggleNekoToc = toggleNekoToc;
    window.hideNekoToc = hideNekoToc;
    window.showNekoToc = showNekoToc;
    
})();
</script>
{% endif %}
