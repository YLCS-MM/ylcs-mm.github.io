<!-- _includes/toc-sidebar.html -->
{% if page.toc != false and site.toc.enabled %}
<aside class="neko-toc-sidebar" id="nekoTocSidebar" style="display:none;position:fixed;top:0;right:0;width:100%;max-width:400px;height:100vh;background:#fff0f5;z-index:2147483647;border-left:3px solid #ffb6c1;">
  <div style="display:flex;align-items:center;padding:20px;background:white;border-bottom:2px dashed #ffb6c1;">
    <span style="font-size:24px;margin-right:10px;">ğŸ¾</span>
    <h3 style="flex:1;margin:0;color:#ff69b4;font-size:18px;">
      {% if site.toc.title %}{{ site.toc.title }}{% else %}æ–‡ç« ç›®å½•{% endif %}
    </h3>
    <button id="nekoTocClose" onclick="window.hideTocSidebar()" 
            style="background:#ff69b4;color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:24px;cursor:pointer;">
      âœ•
    </button>
  </div>
  
  <div style="flex:1;overflow-y:auto;padding:20px;">
    {% include toc.html html=content sanitize=true class="neko-toc-list" h_min=site.toc.min_level h_max=site.toc.max_level %}
  </div>
</aside>

<!-- æ±‰å ¡èœå•æŒ‰é’® -->
<button id="nekoTocToggle" onclick="window.toggleTocSidebar()" 
        style="position:fixed;top:20px;right:20px;width:50px;height:50px;background:#ff69b4;border-radius:50%;border:none;color:white;font-size:20px;z-index:2147483646;cursor:pointer;display:flex;align-items:center;justify-content:center;">
  ğŸ“‘
</button>

<!-- é®ç½©å±‚ -->
<div id="nekoTocOverlay" onclick="window.hideTocSidebar()" 
     style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2147483646;display:none;"></div>

<script>
// ä¸“é—¨ä¿®å¤Viaæµè§ˆå™¨çš„ç›®å½•æ§åˆ¶å‡½æ•°
(function() {
    'use strict';
    
    // é˜²æ­¢é‡å¤åˆå§‹åŒ–
    if (window.tocInitialized) return;
    window.tocInitialized = true;
    
    // è·å–å…ƒç´ 
    var sidebar = document.getElementById('nekoTocSidebar');
    var toggle = document.getElementById('nekoTocToggle');
    var closeBtn = document.getElementById('nekoTocClose');
    var overlay = document.getElementById('nekoTocOverlay');
    
    // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
    if (!sidebar || !toggle) {
        console.warn('ç›®å½•å…ƒç´ æœªæ‰¾åˆ°');
        return;
    }
    
    // æ˜¾ç¤ºç›®å½•
    function showTocSidebar() {
        if (sidebar) {
            sidebar.style.display = 'flex';
            sidebar.style.flexDirection = 'column';
        }
        if (overlay) {
            overlay.style.display = 'block';
        }
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
        document.documentElement.style.overflow = 'hidden';
    }
    
    // éšè—ç›®å½• - å¼ºåˆ¶éšè—
    function hideTocSidebar() {
        if (sidebar) {
            sidebar.style.display = 'none';
        }
        if (overlay) {
            overlay.style.display = 'none';
        }
        // æ¢å¤æ»šåŠ¨
        document.body.style.overflow = '';
        document.documentElement.style.overflow = '';
        
        // å¼ºåˆ¶åœæ­¢ä»»ä½•å¯èƒ½çš„äº‹ä»¶ä¼ æ’­
        if (window.event) {
            window.event.stopPropagation();
            window.event.preventDefault();
        }
    }
    
    // åˆ‡æ¢ç›®å½•
    function toggleTocSidebar() {
        var isVisible = sidebar.style.display === 'flex' || 
                       sidebar.style.display === '' && window.getComputedStyle(sidebar).display === 'flex';
        
        if (isVisible) {
            hideTocSidebar();
        } else {
            showTocSidebar();
        }
    }
    
    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
    function initTocSidebar() {
        // ä½¿ç”¨æœ€ç®€å•çš„äº‹ä»¶ç»‘å®šæ–¹å¼
        if (toggle) {
            toggle.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleTocSidebar();
                return false;
            };
        }
        
        if (closeBtn) {
            closeBtn.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                hideTocSidebar();
                return false;
            };
        }
        
        if (overlay) {
            overlay.onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                hideTocSidebar();
                return false;
            };
        }
        
        // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
        var tocLinks = document.querySelectorAll('.neko-toc-link');
        for (var i = 0; i < tocLinks.length; i++) {
            tocLinks[i].onclick = function(e) {
                e.preventDefault();
                e.stopPropagation();
                var targetId = this.getAttribute('href');
                if (targetId && targetId.startsWith('#')) {
                    hideTocSidebar();
                    var targetElement = document.getElementById(targetId.substring(1));
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'auto'
                        });
                    }
                }
                return false;
            };
        }
        
        // ESCé”®å…³é—­
        document.onkeydown = function(e) {
            e = e || window.event;
            if (e.key === 'Escape' || e.keyCode === 27) {
                hideTocSidebar();
                if (e.preventDefault) e.preventDefault();
                return false;
            }
        };
        
        // ç¡®ä¿åˆå§‹çŠ¶æ€æ˜¯éšè—çš„
        setTimeout(function() {
            hideTocSidebar();
        }, 100);
        
        // ç›‘å¬è·¯ç”±å˜åŒ–ï¼ˆå•é¡µåº”ç”¨ï¼‰
        if (window.MutationObserver) {
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        // é¡µé¢ç±»åå˜åŒ–æ—¶éšè—ç›®å½•
                        hideTocSidebar();
                    }
                });
            });
            
            observer.observe(document.body, {
                attributes: true,
                attributeFilter: ['class']
            });
        }
    }
    
    // æš´éœ²å‡½æ•°åˆ°å…¨å±€
    window.showTocSidebar = showTocSidebar;
    window.hideTocSidebar = hideTocSidebar;
    window.toggleTocSidebar = toggleTocSidebar;
    
    // é¡µé¢åŠ è½½ååˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTocSidebar);
    } else {
        initTocSidebar();
    }
    
    // æ·»åŠ é”™è¯¯å¤„ç†
    window.addEventListener('error', function(e) {
        console.error('ç›®å½•é”™è¯¯:', e.error);
        // å‡ºé”™æ—¶å¼ºåˆ¶éšè—ç›®å½•
        hideTocSidebar();
    });
})();

// å¼ºåˆ¶é˜»æ­¢Viaæµè§ˆå™¨çš„è‡ªåŠ¨å¼¹å‡º
(function() {
    // ç›‘å¬å¯èƒ½çš„è‡ªåŠ¨è§¦å‘
    var originalAddEventListener = Element.prototype.addEventListener;
    Element.prototype.addEventListener = function(type, listener, options) {
        // è¿‡æ»¤æ‰å¯èƒ½å¯¼è‡´è‡ªåŠ¨å¼¹å‡ºçš„äº‹ä»¶
        if (type === 'load' || type === 'DOMContentLoaded') {
            var wrappedListener = function(e) {
                // ç¡®ä¿ç›®å½•åˆå§‹çŠ¶æ€æ˜¯éšè—çš„
                setTimeout(function() {
                    if (window.hideTocSidebar) {
                        window.hideTocSidebar();
                    }
                }, 500);
                return listener(e);
            };
            return originalAddEventListener.call(this, type, wrappedListener, options);
        }
        return originalAddEventListener.call(this, type, listener, options);
    };
})();
</script>

<style>
/* æœ€å°åŒ–çš„CSS - é¿å…Viaæµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜ */
#nekoTocSidebar {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

#nekoTocSidebar * {
    box-sizing: border-box;
}

.neko-toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.neko-toc-list li {
    margin-bottom: 8px;
}

.neko-toc-link {
    display: block;
    padding: 10px 15px;
    color: #666;
    text-decoration: none;
    border-radius: 8px;
    transition: none;
    border-left: 3px solid transparent;
}

.neko-toc-link:hover {
    background: #f0f0f0;
    color: #ff69b4;
}

.neko-toc-link.active {
    background: #ffe6f0;
    color: #ff69b4;
    border-left-color: #ff69b4;
    font-weight: bold;
}

.neko-toc-list .neko-toc-list {
    margin-left: 15px;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    #nekoTocSidebar {
        max-width: 100% !important;
    }
    
    #nekoTocToggle {
        top: 15px !important;
        right: 15px !important;
        width: 45px !important;
        height: 45px !important;
    }
}

/* æ‰“å°æ—¶éšè— */
@media print {
    #nekoTocSidebar,
    #nekoTocToggle,
    #nekoTocOverlay {
        display: none !important;
    }
}
</style>
{% endif %}
