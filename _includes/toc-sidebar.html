<!-- _includes/toc-sidebar.html -->
{% if page.toc != false and site.toc.enabled %}
<aside class="neko-toc-sidebar" id="nekoTocSidebar">
  <div class="neko-toc-header">
    <span class="neko-toc-icon">ğŸ¾</span>
    <h3 class="neko-toc-title">
      {% if site.toc.title %}
        {{ site.toc.title }}
      {% else %}
        æ–‡ç« ç›®å½•
      {% endif %}
    </h3>
    <button class="neko-toc-close" id="nekoTocClose" aria-label="å…³é—­ç›®å½•">âœ•</button>
  </div>
  
  <div class="neko-toc-content">
    {% include toc.html html=content sanitize=true class="neko-toc-list" h_min=site.toc.min_level h_max=site.toc.max_level %}
  </div>
</aside>

<!-- æ±‰å ¡èœå•æŒ‰é’® -->
<button class="neko-toc-toggle" id="nekoTocToggle" aria-label="æ˜¾ç¤º/éšè—ç›®å½•">
  <span class="neko-toc-toggle-icon">ğŸ“‘</span>
</button>

<!-- é®ç½©å±‚ -->
<div class="neko-toc-overlay" id="nekoTocOverlay"></div>

<style>
/* CSSé‡ç½® - ç¡®ä¿è·¨æµè§ˆå™¨ä¸€è‡´æ€§ */
.neko-toc-sidebar * {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* ç›®å½•ä¾§è¾¹æ æ ·å¼ */
.neko-toc-sidebar {
  position: fixed;
  top: 0;
  right: -400px;
  width: 100%;
  max-width: 400px;
  height: 100vh;
  background: linear-gradient(135deg, #fff0f5 0%, #e6f7ff 100%);
  background: -webkit-linear-gradient(135deg, #fff0f5 0%, #e6f7ff 100%);
  box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
  z-index: 10000;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1), -webkit-transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border-left: 3px solid #ffb6c1;
}

.neko-toc-sidebar.active {
  right: 0;
  transform: translateX(0);
  -webkit-transform: translateX(0);
}

/* ä¿®å¤iOS Safariçš„è§†å£é«˜åº¦é—®é¢˜ */
@supports (-webkit-touch-callout: none) {
  .neko-toc-sidebar {
    height: -webkit-fill-available;
  }
}

/* ç›®å½•å¤´éƒ¨æ ·å¼ */
.neko-toc-header {
  display: flex;
  align-items: center;
  padding: 20px;
  background: rgba(255, 255, 255, 0.9);
  border-bottom: 2px dashed #ffb6c1;
  flex-shrink: 0;
}

.neko-toc-icon {
  font-size: 24px;
  margin-right: 10px;
}

.neko-toc-title {
  font-size: 18px;
  color: #ff69b4;
  font-weight: bold;
  flex: 1;
  margin: 0;
}

.neko-toc-close {
  background: none;
  border: none;
  font-size: 24px;
  color: #ff69b4;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.3s ease;
  -webkit-tap-highlight-color: transparent;
}

.neko-toc-close:hover,
.neko-toc-close:focus {
  background: #ffb6c1;
  color: white;
  transform: scale(1.1);
  -webkit-transform: scale(1.1);
}

/* ç›®å½•å†…å®¹åŒºåŸŸ */
.neko-toc-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  -webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
}

/* è‡ªå®šä¹‰ç›®å½•åˆ—è¡¨æ ·å¼ */
.neko-toc-list {
  list-style: none;
}

.neko-toc-list li {
  margin-bottom: 8px;
  position: relative;
}

.neko-toc-link {
  display: block;
  padding: 10px 15px;
  color: #666;
  text-decoration: none;
  border-radius: 8px;
  transition: all 0.3s ease;
  border-left: 3px solid transparent;
  font-size: 14px;
  line-height: 1.4;
  word-break: break-word;
}

.neko-toc-link:hover,
.neko-toc-link:focus {
  background: rgba(255, 182, 193, 0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  transform: translateX(5px);
  -webkit-transform: translateX(5px);
}

.neko-toc-link.active {
  background: rgba(255, 105, 180, 0.1);
  color: #ff69b4;
  border-left-color: #ff69b4;
  font-weight: bold;
}

/* å±‚çº§ç¼©è¿› */
.neko-toc-list .neko-toc-list {
  margin-left: 15px;
  margin-top: 5px;
}

/* æ±‰å ¡èœå•æŒ‰é’® */
.neko-toc-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, #ff69b4, #ff1493);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(255, 105, 180, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  -webkit-tap-highlight-color: transparent;
}

.neko-toc-toggle:hover,
.neko-toc-toggle:focus {
  transform: scale(1.1);
  -webkit-transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(255, 105, 180, 0.4);
}

.neko-toc-toggle-icon {
  font-size: 20px;
  color: white;
}

/* é®ç½©å±‚ */
.neko-toc-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  -webkit-backdrop-filter: blur(2px);
  backdrop-filter: blur(2px);
}

.neko-toc-overlay.active {
  opacity: 1;
  visibility: visible;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .neko-toc-sidebar {
    max-width: 100%;
    right: -100%;
  }
  
  .neko-toc-toggle {
    width: 45px;
    height: 45px;
    top: 15px;
    right: 15px;
  }
  
  .neko-toc-header {
    padding: 15px;
  }
  
  .neko-toc-content {
    padding: 15px;
  }
}

@media (max-width: 480px) {
  .neko-toc-sidebar {
    border-left: none;
    border-right: 3px solid #ffb6c1;
  }
  
  .neko-toc-toggle {
    width: 40px;
    height: 40px;
  }
  
  .neko-toc-toggle-icon {
    font-size: 18px;
  }
}

/* é’ˆå¯¹æ—§ç‰ˆæµè§ˆå™¨çš„å›é€€æ ·å¼ */
@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {
  /* IE10+ ç‰¹å®šæ ·å¼ */
  .neko-toc-sidebar {
    transition: right 0.3s ease;
  }
  
  .neko-toc-link:hover {
    background: #f0f0f0;
  }
}

/* æ‰“å°æ ·å¼ - éšè—ç›®å½• */
@media print {
  .neko-toc-sidebar,
  .neko-toc-toggle,
  .neko-toc-overlay {
    display: none !important;
  }
}
</style>

<script>
// çŒ«å¨˜é£æ ¼ç›®å½•æ§åˆ¶å‡½æ•° - å¢å¼ºå…¼å®¹æ€§
(function() {
  'use strict';
  
  // é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–
  if (window.nekoTocInitialized) {
    return;
  }
  window.nekoTocInitialized = true;
  
  // è·å–DOMå…ƒç´ 
  var sidebar = document.getElementById('nekoTocSidebar');
  var toggle = document.getElementById('nekoTocToggle');
  var closeBtn = document.getElementById('nekoTocClose');
  var overlay = document.getElementById('nekoTocOverlay');
  
  // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
  if (!sidebar || !toggle) {
    console.warn('ç›®å½•ä¾§è¾¹æ å…ƒç´ æœªæ‰¾åˆ°');
    return;
  }
  
  // åˆ‡æ¢ç›®å½•æ˜¾ç¤º/éšè—
  function toggleNekoToc() {
    if (!sidebar || !overlay) return;
    
    var isActive = sidebar.classList.contains('active');
    
    if (isActive) {
      hideNekoToc();
    } else {
      showNekoToc();
    }
  }
  
  // æ˜¾ç¤ºç›®å½•
  function showNekoToc() {
    if (!sidebar || !overlay) return;
    
    sidebar.classList.add('active');
    overlay.classList.add('active');
    
    // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'hidden';
    
    // ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ è§¦æ‘¸äº‹ä»¶å¤„ç†
    if ('ontouchstart' in window) {
      document.addEventListener('touchmove', preventScroll, { passive: false });
    }
  }
  
  // éšè—ç›®å½•
  function hideNekoToc() {
    if (!sidebar || !overlay) return;
    
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
    
    // æ¢å¤èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = '';
    
    // ç§»é™¤è§¦æ‘¸äº‹ä»¶å¤„ç†
    if ('ontouchstart' in window) {
      document.removeEventListener('touchmove', preventScroll);
    }
  }
  
  // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
  function preventScroll(e) {
    e.preventDefault();
  }
  
  // é«˜äº®å½“å‰ç« èŠ‚
  function highlightActiveToc() {
    var tocLinks = document.querySelectorAll('.neko-toc-link');
    if (tocLinks.length === 0) return;
    
    var sections = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    var currentSection = '';
    var scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    
    // æŸ¥æ‰¾å½“å‰å¯è§çš„ç« èŠ‚
    for (var i = 0; i < sections.length; i++) {
      var section = sections[i];
      var sectionTop = section.offsetTop - 100;
      
      if (scrollPosition >= sectionTop) {
        currentSection = section.id;
      } else {
        break;
      }
    }
    
    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
    for (var j = 0; j < tocLinks.length; j++) {
      tocLinks[j].classList.remove('active');
    }
    
    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
    if (currentSection) {
      var activeLink = document.querySelector('.neko-toc-link[href="#' + currentSection + '"]');
      if (activeLink) {
        activeLink.classList.add('active');
        
        // ç¡®ä¿æ´»åŠ¨é“¾æ¥åœ¨å¯è§†åŒºåŸŸå†…
        var tocContent = document.querySelector('.neko-toc-content');
        if (tocContent && activeLink.offsetTop > tocContent.clientHeight) {
          tocContent.scrollTop = activeLink.offsetTop - 100;
        }
      }
    }
  }
  
  // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
  function smoothScrollTo(targetId) {
    var targetElement = document.getElementById(targetId);
    if (!targetElement) return;
    
    var targetPosition = targetElement.offsetTop - 80;
    var startPosition = window.pageYOffset;
    var distance = targetPosition - startPosition;
    var duration = 500;
    var startTime = null;
    
    function animation(currentTime) {
      if (startTime === null) startTime = currentTime;
      var timeElapsed = currentTime - startTime;
      var run = easeInOutQuad(timeElapsed, startPosition, distance, duration);
      window.scrollTo(0, run);
      if (timeElapsed < duration) {
        requestAnimationFrame(animation);
      }
    }
    
    // ç¼“åŠ¨å‡½æ•°
    function easeInOutQuad(t, b, c, d) {
      t /= d/2;
      if (t < 1) return c/2*t*t + b;
      t--;
      return -c/2 * (t*(t-2) - 1) + b;
    }
    
    requestAnimationFrame(animation);
  }
  
  // åˆå§‹åŒ–å‡½æ•°
  function initNekoToc() {
    // æ·»åŠ äº‹ä»¶ç›‘å¬
    if (toggle) {
      toggle.addEventListener('click', toggleNekoToc);
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', hideNekoToc);
    }
    
    if (overlay) {
      overlay.addEventListener('click', hideNekoToc);
    }
    
    // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
    var tocLinks = document.querySelectorAll('.neko-toc-link');
    for (var i = 0; i < tocLinks.length; i++) {
      tocLinks[i].addEventListener('click', function(e) {
        e.preventDefault();
        var targetId = this.getAttribute('href').substring(1);
        hideNekoToc();
        smoothScrollTo(targetId);
      });
    }
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    window.addEventListener('scroll', function() {
      // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
      requestAnimationFrame(highlightActiveToc);
    });
    
    // åˆå§‹é«˜äº®
    highlightActiveToc();
    
    // ç›‘å¬ESCé”®å…³é—­ç›®å½•
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' || e.keyCode === 27) {
        hideNekoToc();
      }
    });
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        // åœ¨æ¡Œé¢ç«¯è‡ªåŠ¨éšè—é®ç½©å±‚
        overlay.classList.remove('active');
      }
    });
  }
  
  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNekoToc);
  } else {
    initNekoToc();
  }
  
  // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿HTMLä¸­è°ƒç”¨
  window.toggleNekoToc = toggleNekoToc;
  window.hideNekoToc = hideNekoToc;
})();
</script>
{% endif %}
